<!doctype html>
<meta charset="utf-8">
<script src="/resources/testdriver.js"></script>
<script src="/resources/testdriver-vendor.js"></script>
<body>
<script>
(async function() {
  // Step 4 (storage-access-api/storage-access-beyond-cookies.sub.https.html)
  let message = "";
  try {
    await test_driver.set_permission({ name: 'storage-access' }, 'granted');
    let handle = await document.requestStorageAccess({all: true});
    if (null != handle.sessionStorage.getItem("test")) {
      message = "Cross-origin first-party Session Storage should be empty";
    }
    if (null != handle.localStorage.getItem("test")) {
      message = "Cross-origin first-party Local Storage should be empty";
    }
  } catch (_) {
    message = "Unable to load handle in cross-origin context";
  }
  await test_driver.set_permission({ name: 'storage-access' }, 'prompt');
  if (message) {
    window.top.postMessage(message, "*");
    return;
  }
  // Step 5 (storage-access-api/storage-access-beyond-cookies.sub.https.html)
  let iframe = document.createElement("iframe");
  iframe.src = "https://{{hosts[][]}}:{{ports[https][0]}}/storage-access-api/resources/storage-access-beyond-cookies-iframe-iframe.html?id="+(new URLSearchParams(window.location.search)).get("id");
  document.body.appendChild(iframe);
})();
</script>
</body>
